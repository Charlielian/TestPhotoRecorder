name: Build Android APK V3.3

on:
  push:
    branches: [ main, develop, fix-buildozer-issue ]
    tags:
      - 'v*'
  pull_request:
    branches: [ main ]
  workflow_dispatch:
    inputs:
      version:
        description: 'Version number (e.g., 1.0.0)'
        required: false
        default: 'auto'

jobs:
  build:
    runs-on: ubuntu-latest

    env:
      GRADLE_OPTS: -Dorg.gradle.daemon=false -Dorg.gradle.parallel=true -Dorg.gradle.caching=true

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Set up JDK 17
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'

    - name: Setup Gradle
      uses: gradle/gradle-build-action@v2
      with:
        gradle-version: wrapper
        cache-read-only: false

    - name: Grant execute permission for gradlew
      run: chmod +x gradlew

    - name: Validate Gradle wrapper
      uses: gradle/wrapper-validation-action@v1

    - name: Get version info
      id: version
      run: |
        if [ "${{ github.event.inputs.version }}" != "" ] && [ "${{ github.event.inputs.version }}" != "auto" ]; then
          echo "VERSION=${{ github.event.inputs.version }}" >> $GITHUB_OUTPUT
        elif [[ $GITHUB_REF == refs/tags/* ]]; then
          echo "VERSION=${GITHUB_REF#refs/tags/v}" >> $GITHUB_OUTPUT
        else
          echo "VERSION=1.0.${{ github.run_number }}" >> $GITHUB_OUTPUT
        fi
        echo "BUILD_TIME=$(date +'%Y-%m-%d %H:%M:%S')" >> $GITHUB_OUTPUT
        echo "COMMIT_SHA=${GITHUB_SHA::8}" >> $GITHUB_OUTPUT

    - name: Display build info
      run: |
        echo "Building version: ${{ steps.version.outputs.VERSION }}"
        echo "Build time: ${{ steps.version.outputs.BUILD_TIME }}"
        echo "Commit: ${{ steps.version.outputs.COMMIT_SHA }}"

    - name: Clean project
      run: ./gradlew clean --no-daemon

    - name: Build debug APK
      run: ./gradlew assembleDebug --no-daemon --stacktrace
      continue-on-error: false

    - name: Build release APK
      run: ./gradlew assembleRelease --no-daemon --stacktrace
      continue-on-error: true

    - name: Run lint checks
      run: ./gradlew lintDebug --no-daemon
      continue-on-error: true

    - name: Generate build report
      if: always()
      run: |
        echo "# Build Report" > build-report.md
        echo "" >> build-report.md
        echo "**Version:** ${{ steps.version.outputs.VERSION }}" >> build-report.md
        echo "**Build Time:** ${{ steps.version.outputs.BUILD_TIME }}" >> build-report.md
        echo "**Commit:** ${{ steps.version.outputs.COMMIT_SHA }}" >> build-report.md
        echo "" >> build-report.md

        if [ -f "app/build/outputs/apk/debug/app-debug.apk" ]; then
          DEBUG_SIZE=$(du -h "app/build/outputs/apk/debug/app-debug.apk" | cut -f1)
          echo "**Debug APK Size:** $DEBUG_SIZE" >> build-report.md
        fi

        if [ -f "app/build/outputs/apk/release/app-release-unsigned.apk" ]; then
          RELEASE_SIZE=$(du -h "app/build/outputs/apk/release/app-release-unsigned.apk" | cut -f1)
          echo "**Release APK Size:** $RELEASE_SIZE" >> build-report.md
        fi

    - name: Upload debug APK
      if: success()
      uses: actions/upload-artifact@v4
      with:
        name: SignalTestApp-debug-v${{ steps.version.outputs.VERSION }}
        path: app/build/outputs/apk/debug/app-debug.apk
        retention-days: 30

    - name: Upload release APK
      if: success()
      uses: actions/upload-artifact@v4
      with:
        name: SignalTestApp-release-v${{ steps.version.outputs.VERSION }}
        path: app/build/outputs/apk/release/app-release-unsigned.apk
        retention-days: 90

    - name: Upload lint reports
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: lint-reports
        path: app/build/reports/lint-results-*.html
        retention-days: 7

    - name: Upload build report
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: build-report
        path: build-report.md
        retention-days: 7

    - name: Create GitHub Release
      if: github.event_name == 'push' && (github.ref == 'refs/heads/main' || startsWith(github.ref, 'refs/tags/'))
      uses: softprops/action-gh-release@v1
      with:
        tag_name: v${{ steps.version.outputs.VERSION }}
        name: SignalTestApp v${{ steps.version.outputs.VERSION }}
        body: |
          ## üì± SignalTestApp Release v${{ steps.version.outputs.VERSION }}

          ### üîß Build Information
          - **Version:** ${{ steps.version.outputs.VERSION }}
          - **Build Time:** ${{ steps.version.outputs.BUILD_TIME }}
          - **Commit:** ${{ steps.version.outputs.COMMIT_SHA }}

          ### ‚ú® What's New
          - Fixed critical bugs and improved stability
          - Enhanced memory management
          - Updated to Android 14 (API 34)
          - Improved signal collection accuracy
          - Migrated to scoped storage
          - Added permission checks

          ### üì¶ Downloads
          - **app-debug.apk**: Debug version with logging enabled (recommended for testing)
          - **app-release-unsigned.apk**: Release version (needs signing for production)

          ### üìã Requirements
          - Android 6.0 (API 23) or higher
          - Recommended: Android 12 (API 31) or higher

          ### üîë Permissions Required
          - Location (Fine & Coarse)
          - Camera
          - Phone State

          ### üìù Installation
          1. Download the APK file
          2. Enable "Install from Unknown Sources" on your device
          3. Install the APK
          4. Grant required permissions

          For more information, see the [README](https://github.com/Charlielian/SignalTestApp/blob/main/README.md)

        files: |
          app/build/outputs/apk/debug/app-debug.apk
          app/build/outputs/apk/release/app-release-unsigned.apk
          build-report.md
        draft: false
        prerelease: false
        generate_release_notes: true
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    - name: Comment on PR
      if: github.event_name == 'pull_request'
      uses: actions/github-script@v7
      with:
        script: |
          const fs = require('fs');
          const report = fs.readFileSync('build-report.md', 'utf8');

          github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: `## ü§ñ Build Status\n\n‚úÖ Build completed successfully!\n\n${report}\n\nüì¶ APK artifacts are available in the workflow run.`
          });

    - name: Notify build failure
      if: failure()
      run: |
        echo "::error::Build failed! Please check the logs for details."
        echo "Common issues:"
        echo "- Gradle build errors"
        echo "- Missing dependencies"
        echo "- Code compilation errors"
        echo "- Resource linking errors"
